// Generated by CoffeeScript 1.9.0
(function() {
  var NodeChat, deliver;

  deliver = function(cb) {
    try {
      return cb();
    } catch (_error) {
      return setTimeout(20, function() {
        return deliver(cb);
      });
    }
  };

  NodeChat = (function() {
    function NodeChat($, User, Ui, io) {
      this.io = io().on('connect', (function(_this) {
        return function() {
          window.console.log('connected');
          _this.window = window;
          _this.$ = $;
          _this._initUi(Ui);
          _this._initUser();
          if (!_this.user.loggedIn) {
            _this.showLoginWindow();
          }
          return _this.io.on('user.join', function(nick) {
            return deliver(function() {
              _this._ui.addUser(nick);
              return _this._ui.addMessage('[чат]', "К нам пришел &quot;" + nick + "&quot;");
            });
          }).on('user.changeNick', function(data) {
            data = JSON.parse(data);
            _this._ui.addUser(data.oldNick);
            _this._ui.removeUser(data.newNick);
            return _this._ui.addMessage('[чат]', "Участника " + data.oldNick + " теперь зовут " + data.newNick);
          }).on('user.leave', function(nick) {
            _this._ui.removeUser(nick);
            return _this._ui.addMessage('[чат]', "Участника " + nick + " бабайка забрала");
          });
        };
      })(this));
    }

    NodeChat.prototype._initUi = function(Ui) {
      return this._ui = new Ui(this.$);
    };

    NodeChat.prototype._initUser = function() {
      var opts;
      opts = {
        onChangeNick: (function(_this) {
          return function(oldNick, newNick) {
            _this._ui.addMessage('[чат]', "Вы вошли под ником &quot;" + newNick + "&quot;");
            if (oldNick != null) {
              return _this.io.emit('changeNick', newNick);
            } else {
              return _this.io.emit('login', newNick);
            }
          };
        })(this)
      };
      return this.user = new User(opts);
    };

    NodeChat.prototype._setupUi = function() {
      return this.node = $('<div/>');
    };

    NodeChat.prototype.showLoginWindow = function() {
      var $node, template, title;
      title = 'Введите ник';
      template = "<div class=\"j-popup b-popup\">\n  <a class=\"j-popup__close b-popup__close\" href=\"#\"></a>\n  <div class=\"b-popup__title\">" + title + "</div>\n  <input type=\"text\" class=\"j-popup__nick b-popup__nick\">\n  <button class=\"j-popup__ok b-popup__ok\">ok</button>\n</div>";
      return $node = $(template).on('click.popup', '.j-popup__close, .j-popup__ok', (function(_this) {
        return function(e) {
          var nick;
          e.preventDefault();
          nick = $node.find('.j-popup__nick').val();
          if (nick) {
            _this.user.setNick(nick);
          }
          return $node.remove();
        };
      })(this)).appendTo('body');
    };

    return NodeChat;

  })();

  window.NodeChat = NodeChat;

}).call(this);

//# sourceMappingURL=NodeChat.js.map
